<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Panel de Cupones â€” Alfeicon Games</title>
<style>
:root{
  --bg:#0f1115; --card:#171a21; --muted:#9aa4b2; --accent:#7c4dff; --ok:#22c55e; --warn:#ef4444;
  --br:14px; --b:1px solid rgba(255,255,255,.08);
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:linear-gradient(180deg,#121318,#0e1014); color:#e8eef7;
  -webkit-tap-highlight-color: transparent;
}
.wrap{max-width:980px; margin:28px auto 60px; padding:0 16px}
h1{font-size:22px; margin:0}
h2{font-size:16px; letter-spacing:.2px; margin:0 0 8px; color:#dbe6ff; font-weight:800}
.card{background:var(--card); border:var(--b); border-radius:var(--br); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.stack{display:grid; gap:16px}
.row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
@media (max-width:840px){ .row{grid-template-columns:1fr} }

label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px; font-weight:600; letter-spacing:.3px}
input,select,button,textarea{
  width:100%; padding:14px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1);
  background:#0f1218; color:#e8eef7; outline:none; font-weight:600; font-size:16px;
}
input:focus,select:focus,textarea:focus{border-color:#2b2f3a; box-shadow:0 0 0 2px rgba(124,77,255,.25)}
.btn{cursor:pointer; background:linear-gradient(135deg,#7c4dff,#4a90e2); border:0; font-weight:800}
.btn.secondary{background:#222831}
.btn.ok{background:linear-gradient(135deg,#22c55e,#16a34a)}
.btn.warn{background:linear-gradient(135deg,#ef4444,#ef7b44)}
.muted{color:var(--muted); font-size:13px}
.section{display:grid; gap:10px}
.section + .section{margin-top:18px}

.actions{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
@media (max-width:840px){ .actions{grid-template-columns:1fr 1fr} }
@media (max-width:420px){ .actions{grid-template-columns:1fr} }

.status{margin-top:10px; padding:12px; border-radius:12px; background:#10141b; border:var(--b); min-height:56px; display:grid; align-content:center}
.badge{display:inline-flex; gap:6px; align-items:center; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:#cfd8e3}
.badge.ok{background:rgba(34,197,94,.08); border-color:rgba(34,197,94,.35)}
.badge.warn{background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.35)}
/* Badges por premio estimado */
.badge.neutral{background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.18); color:#d1d5db}
.badge.p10{background:rgba(59,130,246,.10); border-color:rgba(59,130,246,.35)}
.badge.p25{background:rgba(124,77,255,.10); border-color:rgba(124,77,255,.35)}
.badge.p50{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.38)}
.badge.p100{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.42)}

.topbar{position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:14px; padding:10px 12px; border-radius:12px; background:rgba(23,26,33,.75); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.06);}
.right{display:flex; gap:8px; align-items:center}
.hidden{display:none !important}
.login{max-width:440px; margin:50px auto}
.divider{height:1px; background:rgba(255,255,255,.08); margin:6px 0 2px; border-radius:1px}

/* Tabla */
.table-wrap{border:var(--b); border-radius:12px; background:#12161e; overflow:auto; -webkit-overflow-scrolling: touch;}
table{width:100%; border-collapse:collapse; min-width:780px}
thead{background:#0f141c; position:sticky; top:0; z-index:1}
th,td{padding:12px 12px; border-bottom:1px solid rgba(255,255,255,.06); font-size:14px}
th{font-size:12px; color:#aeb7c5; letter-spacing:.3px; text-align:left}
tbody tr:hover{background:rgba(255,255,255,.03)}
.pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.12)}
.pill.ACTIVO{background:rgba(34,197,94,.08); border-color:rgba(34,197,94,.35)}
.pill.BLOQUEADO{background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.35)}
.pill.USADO{background:rgba(59,130,246,.08); border-color:rgba(59,130,246,.35)}

.toolbar{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end}
.toolbar .filters{display:grid; grid-template-columns:1fr 160px 120px; gap:10px}
@media (max-width:840px){.toolbar{grid-template-columns:1fr}.toolbar .filters{grid-template-columns:1fr 1fr}}
@media (max-width:420px){.toolbar .filters{grid-template-columns:1fr}}
.pager{display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap}
.pager button{width:40px; padding:10px 0; font-size:16px; display:inline-flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid rgba(255,255,255,.1); background:#1a1f28; color:#e8eef7; font-weight:700; cursor:pointer}
.pager button:disabled{opacity:.4; cursor:not-allowed}
.pager span{color:#aeb7c5; font-size:13px}
.spin{animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="wrap stack">

<!-- LOGIN -->
<div id="login-card" class="card login stack">
  <h1>Acceso Panel (Privado)</h1>
  <div class="section">
    <div class="row">
      <div class="section"><label>Usuario</label><input id="in-user" placeholder="admin" autocomplete="username" /></div>
      <div class="section"><label>ContraseÃ±a</label><input id="in-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" /></div>
    </div>
    <button id="btn-login" class="btn">Entrar</button>
  </div>
</div>

<!-- PANEL -->
<div id="panel" class="card hidden stack">
  <div class="topbar">
    <h1 style="font-size:18px">Panel de cupones â€” Alfeicon Games</h1>
    <div class="right"><button id="btn-logout" class="btn secondary">Cerrar sesiÃ³n</button></div>
  </div>

  <!-- ConfiguraciÃ³n -->
  <div class="section">
    <h2>ConfiguraciÃ³n</h2><div class="divider"></div>
    <div class="row">
      <div class="section"><label>Endpoint Apps Script</label><input id="in-endpoint" placeholder="https://script.google.com/macros/s/XXXXXXXX/exec" /></div>
      <div class="section"><label>ADMIN_TOKEN</label><input id="in-token" type="password" placeholder="Token" /></div>
    </div>
  </div>

  <!-- Acciones rÃ¡pidas -->
  <div class="section">
    <h2>Acciones rÃ¡pidas</h2><div class="divider"></div>
    <div class="row">
      <div class="section"><label>CÃ³digo</label><input id="in-code" /></div>
      <div class="section"><label>Premio</label><input id="in-prize" /></div>
    </div>
    <div class="actions">
      <button class="btn" id="btn-validate">Validar</button>
      <button class="btn ok" id="btn-enable">Activar</button>
      <button class="btn warn" id="btn-disable">Bloquear</button>
      <button class="btn" id="btn-used">Marcar usado</button>
    </div>
  </div>

  <!-- Generar cÃ³digos -->
  <div class="section">
    <h2>Generar cÃ³digos</h2><div class="divider"></div>
    <div class="row">
      <div class="section"><label>Premio</label>
        <select id="gen-prize">
          <option>Sin premio ðŸ˜…</option><option>10% OFF</option><option>25% OFF</option><option>50% OFF</option><option>100% OFF</option>
        </select>
      </div>
      <div class="section"><label>Cantidad</label><input id="gen-count" type="number" value="10" /></div>
    </div>
    <div class="row">
      <div class="section"><label>Prefijo</label><input id="gen-prefix" value="ALF-GAMES-" /></div>
      <div class="section"><label>Inicio numeraciÃ³n</label><input id="gen-start" type="number" value="1" /></div>
    </div>
    <button class="btn ok" id="btn-generate">Generar</button>
    <div id="gen-status" class="status">Listo para generar.</div>
  </div>

  <!-- Estado -->
  <div class="section"><h2>Estado</h2><div class="divider"></div><div id="status" class="status">Listo.</div></div>

  <!-- Listado -->
  <div class="section">
    <h2>Listado</h2><div class="divider"></div>
    <div class="toolbar">
      <div class="filters">
        <div><label>Buscar</label><input id="f-q" /></div>
        <div><label>Estado</label><select id="f-state"><option value="ALL">Todos</option><option>ACTIVO</option><option>USADO</option><option>BLOQUEADO</option></select></div>
        <div><label>LÃ­mite</label><select id="f-limit"><option>20</option><option selected>50</option></select></div>
      </div>
      <div class="pager">
        <button id="btn-refresh">â†»</button>
        <button id="btn-prev">â€¹</button>
        <span id="page-info">0â€“0</span>
        <button id="btn-next">â€º</button>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>CÃ³digo</th>
            <th>Estado</th>
            <th>Premio</th>
            <th>Premio estimado</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody id="tbl-body">
          <tr><td colspan="5" class="muted" style="padding:16px">Sin datos.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
</div>

<script>
const $=s=>document.querySelector(s);

/* === LOGIN seguro === */
const CFG_LOGIN={username:"Bastian",pass_hash:"-6edce1de"}; // ejemplo hash
function simpleHash(s){let h=0;for(let i=0;i<s.length;i++){h=(h<<5)-h+s.charCodeAt(i);h|=0;}return h.toString(16);}
const elLogin=$("#login-card"),elPanel=$("#panel");
$("#btn-login").addEventListener("click",()=>{if($("#in-user").value===CFG_LOGIN.username&&simpleHash($("#in-pass").value)===CFG_LOGIN.pass_hash){localStorage.setItem("admin_logged","1");elLogin.classList.add("hidden");elPanel.classList.remove("hidden");loadList(true);}else alert("Usuario o contraseÃ±a invÃ¡lidos");});
$("#btn-logout").addEventListener("click",()=>{localStorage.removeItem("admin_logged");elPanel.classList.add("hidden");elLogin.classList.remove("hidden");});
if(localStorage.getItem("admin_logged")==="1"){elLogin.classList.add("hidden");elPanel.classList.remove("hidden");}

/* === Config === */
const endpoint=$("#in-endpoint"),token=$("#in-token"),code=$("#in-code"),prize=$("#in-prize"),statusBox=$("#status");
endpoint.value=localStorage.getItem("endpoint")||"";token.value=localStorage.getItem("admin_token")||"";
endpoint.addEventListener("change",()=>localStorage.setItem("endpoint",endpoint.value.trim()));
token.addEventListener("change",()=>localStorage.setItem("admin_token",token.value.trim()));
function ensureCfg(){const ep=endpoint.value.trim();if(!ep){alert("Configura el endpoint");return null;}return ep;}
function setStatus(html){statusBox.innerHTML=html;}
async function callAPI(p){const ep=ensureCfg();if(!ep)return null;const r=await fetch(ep+"?"+new URLSearchParams(p),{method:"GET"});if(!r.ok)throw new Error("HTTP "+r.status);return await r.json();}

/* === Acciones rÃ¡pidas === */
$("#btn-validate").addEventListener("click",async()=>{try{const c=(code.value||"").trim().toUpperCase();if(!c)return;const d=await callAPI({action:"validate",code:c});setStatus(`<span class='badge ok'>VALIDATE</span> â€” ${JSON.stringify(d)}`);}catch(e){setStatus(`<span class='badge warn'>ERROR</span> â€” ${e}`);}});
$("#btn-enable").addEventListener("click",async()=>{try{const c=(code.value||"").trim().toUpperCase(),t=token.value.trim();if(!c||!t){alert("CÃ³digo y token requeridos");return;}const d=await callAPI({action:"enable",code:c,token:t});setStatus(`<span class='badge ok'>ENABLE</span> â€” ${JSON.stringify(d)}`);await loadList();}catch(e){setStatus(`<span class='badge warn'>ERROR</span> â€” ${e}`);}});
$("#btn-disable").addEventListener("click",async()=>{try{const c=(code.value||"").trim().toUpperCase(),t=token.value.trim();if(!c||!t){alert("CÃ³digo y token requeridos");return;}const d=await callAPI({action:"disable",code:c,token:t});setStatus(`<span class='badge warn'>DISABLE</span> â€” ${JSON.stringify(d)}`);await loadList();}catch(e){setStatus(`<span class='badge warn'>ERROR</span> â€” ${e}`);}});
$("#btn-used").addEventListener("click",async()=>{try{const c=(code.value||"").trim().toUpperCase(),p=(prize.value||"").trim();if(!c){alert("CÃ³digo requerido");return;}const d=await callAPI({action:"markUsed",code:c,prize:p});setStatus(`<span class='badge'>USED</span> â€” ${JSON.stringify(d)}`);await loadList();}catch(e){setStatus(`<span class='badge warn'>ERROR</span> â€” ${e}`);}});

/* === Generar cÃ³digos por premio === */
const genPrize=$("#gen-prize"),genCount=$("#gen-count"),genPrefix=$("#gen-prefix"),genStart=$("#gen-start"),btnGen=$("#btn-generate"),genStatus=$("#gen-status");
function hash32(s){let h=2166136261>>>0;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);}return h>>>0;}
function pickPrize(code){
  const w={"Sin premio ðŸ˜…":.7,"10% OFF":.2,"25% OFF":.08,"50% OFF":.02,"100% OFF":.001};
  const total=Object.values(w).reduce((a,b)=>a+b,0);
  const n=(hash32(code)%100000)/100000; let acc=0;
  for(const[k,v] of Object.entries(w)){acc+=v/total; if(n<=acc) return k;}
  return "Sin premio ðŸ˜…";
}
btnGen.addEventListener("click",async()=>{
  const t=token.value.trim(); if(!t) return alert("ADMIN_TOKEN requerido");
  const target=genPrize.value, count=+genCount.value||10, prefix=genPrefix.value, start=+genStart.value||1;
  let ok=0, fail=0, res=[];
  for(let i=start;i<start+10000 && res.length<count;i++){
    const code=`${prefix}${String(i).padStart(3,"0")}`;
    if(pickPrize(code)===target) res.push(code);
  }
  for(const c of res){
    try{ const r=await callAPI({action:"enable",code:c,token:t}); if(r.ok) ok++; else fail++; }catch{ fail++; }
  }
  genStatus.innerHTML=`<span class='badge ok'>Listo</span> â€” ${ok}/${res.length} activados. <div class='muted'><code>${res.join(", ")}</code></div>`;
  await loadList(true);
});

/* === Listado === */
const fQ=$("#f-q"),fState=$("#f-state"),fLimit=$("#f-limit"),btnRefresh=$("#btn-refresh"),btnPrev=$("#btn-prev"),btnNext=$("#btn-next"),pageInfo=$("#page-info"),tbody=$("#tbl-body");
let offset=0;

function prizeBadge(prize){
  const map = {
    "Sin premio ðŸ˜…":"neutral",
    "10% OFF":"p10",
    "25% OFF":"p25",
    "50% OFF":"p50",
    "100% OFF":"p100"
  };
  const cls = map[prize] || "neutral";
  return `<span class="badge ${cls}">${prize}</span>`;
}

async function loadList(reset=false){
  btnRefresh.classList.add("spin");
  try{
    const t=token.value.trim();
    if(!t){ tbody.innerHTML="<tr><td colspan='5' class='muted' style='padding:16px'>Falta token</td></tr>"; return; }
    if(reset) offset=0;
    const lim=+fLimit.value||50;
    const d=await callAPI({action:"list",token:t,state:fState.value,q:fQ.value.trim(),limit:lim,offset:offset});
    if(!d || !d.ok) throw new Error("Respuesta invÃ¡lida");

    // Render con â€œPremio estimadoâ€
    tbody.innerHTML=(d.items||[]).map(row=>{
      const fecha=row.fecha ? new Date(row.fecha).toLocaleString() : "â€”";
      const estimado = prizeBadge(pickPrize(row.code));
      return `<tr>
        <td><code>${row.code}</code></td>
        <td><span class="pill ${row.state}">${row.state}</span></td>
        <td>${row.prize || "â€”"}</td>
        <td>${estimado}</td>
        <td>${fecha}</td>
      </tr>`;
    }).join("") || `<tr><td colspan="5" class="muted" style="padding:16px">Sin resultados.</td></tr>`;

    const total=d.total||0, end=Math.min(offset+lim,total), start=total?offset+1:0;
    pageInfo.textContent=`${start}â€“${end} de ${total}`;
    btnPrev.disabled=offset===0; btnNext.disabled=end>=total;
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="5" class="muted" style="padding:16px">Error cargando lista: ${e}</td></tr>`;
  }finally{
    btnRefresh.classList.remove("spin");
  }
}

btnRefresh.addEventListener("click",()=>loadList(true));
fQ.addEventListener("input",()=>loadList(true));
fState.addEventListener("change",()=>loadList(true));
fLimit.addEventListener("change",()=>loadList(true));
btnPrev.addEventListener("click",()=>{offset=Math.max(0,offset-(+fLimit.value||50));loadList();});
btnNext.addEventListener("click",()=>{offset+=+fLimit.value||50;loadList();});
setInterval(()=>loadList(),60000);
if(localStorage.getItem("admin_logged")==="1")loadList(true);
</script>
</body>
</html>